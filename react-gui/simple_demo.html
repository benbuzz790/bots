<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bots Framework GUI - Simple Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        .chat-panel {
            flex: 2;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tree-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }
        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }
        .bot-message {
            background: #f3e5f5;
            margin-right: 20px;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .input-area button {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-area button:hover {
            background: #1976d2;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .status.connected {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .status.disconnected {
            background: #ffcdd2;
            color: #c62828;
        }
        .status.thinking {
            background: #fff3e0;
            color: #ef6c00;
        }
        .tree-display {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
            font-family: monospace;
            font-size: 12px;
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Bots Framework GUI - Simple Demo</h1>
    <div class="container">
        <div class="chat-panel">
            <h2>Chat Interface</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message here..." />
                <button onclick="sendMessage()">Send</button>
                <button onclick="createBot()">New Bot</button>
            </div>
        </div>
        <div class="tree-panel">
            <h2>Conversation Tree</h2>
            <div id="treeDisplay" class="tree-display">
                No conversation yet...
            </div>
            <div style="margin-top: 10px;">
                <button onclick="navigateUp()">‚Üë Up</button>
                <button onclick="navigateDown()">‚Üì Down</button>
                <button onclick="navigateLeft()">‚Üê Left</button>
                <button onclick="navigateRight()">‚Üí Right</button>
            </div>
        </div>
    </div>
    <script>
        let ws = null;
        let currentBotId = null;
        let isConnected = false;
        // DOM elements
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const treeDisplay = document.getElementById('treeDisplay');
        // Connect to WebSocket
        function connect() {
            try {
                ws = new WebSocket('ws://localhost:8000/ws');
                ws.onopen = function() {
                    isConnected = true;
                    updateStatus('Connected', 'connected');
                    console.log('WebSocket connected');
                };
                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };
                ws.onclose = function() {
                    isConnected = false;
                    updateStatus('Disconnected', 'disconnected');
                    console.log('WebSocket disconnected');
                };
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateStatus('Connection Error', 'disconnected');
                };
            } catch (error) {
                console.error('Failed to connect:', error);
                updateStatus('Connection Failed', 'disconnected');
            }
        }
        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('Received:', message);
            switch (message.type) {
                case 'bot_created':
                    currentBotId = message.data.botId;
                    addMessage('System', `Bot created: ${currentBotId.substring(0, 8)}`);
                    break;
                case 'bot_response':
                    const { botState } = message.data;
                    if (botState && botState.conversation_tree) {
                        updateConversationDisplay(botState);
                        updateTreeDisplay(botState.conversation_tree, botState.current_node_id);
                    }
                    updateStatus('Connected', 'connected');
                    break;
                case 'bot_thinking':
                    updateStatus('Bot is thinking...', 'thinking');
                    break;
                case 'navigation_response':
                    const navBotState = message.data.botState;
                    if (navBotState) {
                        updateConversationDisplay(navBotState);
                        updateTreeDisplay(navBotState.conversation_tree, navBotState.current_node_id);
                    }
                    break;
                case 'error':
                    addMessage('Error', message.data.message);
                    updateStatus('Error: ' + message.data.message, 'disconnected');
                    break;
            }
        }
        // Update status display
        function updateStatus(text, className) {
            statusEl.textContent = text;
            statusEl.className = `status ${className}`;
        }
        // Add message to chat display
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role.toLowerCase()}-message`;
            messageDiv.innerHTML = `<strong>${role}:</strong> ${content}`;
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        // Update conversation display from bot state
        function updateConversationDisplay(botState) {
            // Clear existing messages
            messagesEl.innerHTML = '';
            // Get current conversation path
            const tree = botState.conversation_tree;
            const currentNodeId = botState.current_node_id;
            // Build path from root to current
            const path = [];
            let nodeId = currentNodeId;
            while (nodeId && tree[nodeId]) {
                path.unshift(tree[nodeId]);
                nodeId = tree[nodeId].parent;
            }
            // Display messages in path
            path.forEach(node => {
                if (node.message && node.message.content.trim()) {
                    const role = node.message.role === 'user' ? 'User' : 'Bot';
                    addMessage(role, node.message.content);
                }
            });
        }
        // Update tree display
        function updateTreeDisplay(tree, currentNodeId) {
            let treeText = 'Conversation Tree:\n\n';
            // Find root nodes (nodes with no parent)
            const rootNodes = Object.values(tree).filter(node => !node.parent);
            rootNodes.forEach(root => {
                treeText += buildTreeText(tree, root, 0, currentNodeId);
            });
            treeDisplay.textContent = treeText;
        }
        // Build tree text representation
        function buildTreeText(tree, node, depth, currentNodeId) {
            const indent = '  '.repeat(depth);
            const marker = node.id === currentNodeId ? '‚ñ∫ ' : '  ';
            const role = node.message.role === 'user' ? 'üë§' : 'ü§ñ';
            const preview = node.message.content.substring(0, 30) + (node.message.content.length > 30 ? '...' : '');
            let text = `${indent}${marker}${role} ${preview}\n`;
            // Add children
            node.children.forEach(childId => {
                if (tree[childId]) {
                    text += buildTreeText(tree, tree[childId], depth + 1, currentNodeId);
                }
            });
            return text;
        }
        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected || !currentBotId) {
                if (!currentBotId) {
                    alert('Please create a bot first');
                }
                return;
            }
            // Add user message to display immediately
            addMessage('User', content);
            // Send to WebSocket
            ws.send(JSON.stringify({
                type: 'send_message',
                data: {
                    botId: currentBotId,
                    content: content
                }
            }));
            messageInput.value = '';
            updateStatus('Bot is thinking...', 'thinking');
        }
        // Create new bot
        function createBot() {
            if (!isConnected) {
                alert('Please wait for connection');
                return;
            }
            ws.send(JSON.stringify({
                type: 'create_bot',
                data: {
                    name: 'Demo Bot'
                }
            }));
        }
        // Navigation functions
        function navigateUp() {
            navigate('up');
        }
        function navigateDown() {
            navigate('down');
        }
        function navigateLeft() {
            navigate('left');
        }
        function navigateRight() {
            navigate('right');
        }
        function navigate(direction) {
            if (!isConnected || !currentBotId) {
                return;
            }
            ws.send(JSON.stringify({
                type: 'navigate',
                data: {
                    botId: currentBotId,
                    direction: direction
                }
            }));
        }
        // Handle Enter key in input
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        // Connect on page load
        window.onload = function() {
            connect();
        };
    </script>
</body>
</html>
