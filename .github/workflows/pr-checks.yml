name: PR Checks

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8

jobs:
  tests:
    name: Run Tests with Coverage
    runs-on: windows-latest
    timeout-minutes: 75
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GH_TOKEN: ${{ github.token }}
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Configure UTF-8 encoding
        shell: pwsh
        run: |
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
      - name: Restore requirements lock from cache
        id: cache-requirements-lock
        uses: actions/cache@v4
        with:
          path: requirements.lock
          key: requirements-lock-${{ runner.os }}-${{ hashFiles('requirements.txt', 'requirements-dev.txt', 'setup.py') }}
          restore-keys: |
            requirements-lock-${{ runner.os }}-
      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-cache-${{ runner.os }}-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            pip-cache-${{ runner.os }}-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .[dev]

      - name: Generate requirements lock file
        run: |
          pip freeze > requirements.lock

      - name: Upload requirements lock
        uses: actions/upload-artifact@v4
        with:
          name: requirements-lock
          path: requirements.lock
          retention-days: 30

      - name: Remove BOMs from all files
        run: |
          python -m bots.dev.remove_boms

      - name: Run tests with coverage
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != ''
        run: |
          pytest tests/ -n 12 --tb=short -v --maxfail=10 --cov=bots --cov-report=term-missing --cov-report=xml


      - name: Run installation tests (serial)
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != ''
        run: |
          pytest tests/test_install_in_fresh_environment.py -n0 -v --tb=short
        continue-on-error: false

      - name: Run serial tests (tests that require -n0)
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != ''
        run: |
          pytest tests/e2e/test_cli_load.py -n0 -v --tb=short
          pytest tests/e2e/test_combine_leaves.py -n0 -v --tb=short
          pytest tests/e2e/test_keyboard_interrupt_handling.py -n0 -v --tb=short
          pytest tests/e2e/test_prompt_management.py -n0 -v --tb=short
          pytest tests/e2e/test_quiet_duplicate.py -n0 -v --tb=short
          pytest tests/e2e/test_quiet_fix_verification.py -n0 -v --tb=short
          pytest tests/e2e/test_wizard_debug.py -n0 -v --tb=short
          pytest tests/integration/test_observability_integration.py -n0 -v --tb=short
        continue-on-error: false
      - name: Check coverage threshold
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != ''
        run: |
          pip install coverage
          coverage report --fail-under=50

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: env.OPENAI_API_KEY != '' || env.ANTHROPIC_API_KEY != ''
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  code-quality:
    name: Code Quality & Linting
    runs-on: windows-latest
    timeout-minutes: 75
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Configure UTF-8 encoding
        shell: pwsh
        run: |
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
      - name: Restore requirements lock from cache
        id: cache-requirements-lock
        uses: actions/cache@v4
        with:
          path: requirements.lock
          key: requirements-lock-${{ runner.os }}-${{ hashFiles('requirements.txt', 'requirements-dev.txt', 'setup.py') }}
          restore-keys: |
            requirements-lock-${{ runner.os }}-
      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-cache-${{ runner.os }}-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            pip-cache-${{ runner.os }}-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Remove BOMs from all files
        run: |
          python -m bots.dev.remove_boms

      - name: Check Black formatting
        run: |
          black --check --diff .

      - name: Check isort import sorting
        run: |
          isort --check-only --diff .

      - name: Run flake8 linting
        run: |
          flake8 . --count --statistics --show-source

      - name: Run mypy type checking
        run: |
          mypy bots/ --ignore-missing-imports
        continue-on-error: true


  security:
    name: Security Scan
    runs-on: windows-latest
    timeout-minutes: 75
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Configure UTF-8 encoding
        shell: pwsh
        run: |
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
      - name: Restore requirements lock from cache
        id: cache-requirements-lock
        uses: actions/cache@v4
        with:
          path: requirements.lock
          key: requirements-lock-${{ runner.os }}-${{ hashFiles('requirements.txt', 'requirements-dev.txt', 'setup.py') }}
          restore-keys: |
            requirements-lock-${{ runner.os }}-
      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-cache-${{ runner.os }}-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            pip-cache-${{ runner.os }}-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit
          pip install -r requirements.txt

      - name: Run Bandit security scan
        run: |
          bandit -r bots/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 7
