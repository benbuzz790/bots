

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bots.dev.decorators &mdash; bots 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            bots
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bots</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bots.dev.decorators</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bots.dev.decorators</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Development decorators for enhancing bot functionality and debugging.</span>

<span class="sd">This module provides decorators and utilities for:</span>
<span class="sd">- Lazy function implementation using LLMs (@lazy)</span>
<span class="sd">- Post-mortem debugging on exceptions (@debug_on_error)</span>
<span class="sd">- HTTP logging filters for cleaner output</span>

<span class="sd">The primary features are:</span>
<span class="sd">- @lazy: Generates function implementations at runtime using LLM</span>
<span class="sd">- @debug_on_error: Launches pdb debugger on exceptions</span>
<span class="sd">- NoHTTPFilter: Filters out HTTP-related logging noise</span>

<span class="sd">Example:</span>
<span class="sd">    from bots.dev.decorators import lazy, debug_on_error</span>
<span class="sd">    </span>
<span class="sd">    @lazy(&quot;Implement a quicksort algorithm&quot;)</span>
<span class="sd">    def sort_list(items: list) -&gt; list:</span>
<span class="sd">        pass  # Implementation will be generated by LLM</span>
<span class="sd">        </span>
<span class="sd">    @debug_on_error</span>
<span class="sd">    def risky_operation():</span>
<span class="sd">        # Will launch debugger if this raises an exception</span>
<span class="sd">        process_data()</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bots.utils.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_code_blocks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bots.foundation.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bots</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnthropicBot</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<div class="viewcode-block" id="NoHTTPFilter">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots.NoHTTPFilter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NoHTTPFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filters out logging records containing &#39;response&#39; in the logger name.</span>
<span class="sd">    </span>
<span class="sd">    Use when you need to reduce noise from HTTP-related logging in the application.</span>
<span class="sd">    This filter helps prevent logging output from being flooded with HTTP response</span>
<span class="sd">    logs while still maintaining other important log messages.</span>
<span class="sd">    </span>
<span class="sd">    Inherits from:</span>
<span class="sd">        logging.Filter: Base class for logging filters</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the filter (inherited from logging.Filter)</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        logger = logging.getLogger(__name__)</span>
<span class="sd">        http_filter = NoHTTPFilter()</span>
<span class="sd">        logger.addFilter(http_filter)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NoHTTPFilter.filter">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots.NoHTTPFilter.filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">LogRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the log record should be filtered.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            record (logging.LogRecord): The log record to be checked</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the record should be kept (doesn&#39;t contain &#39;response&#39;),</span>
<span class="sd">                 False if it should be filtered out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;response&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>
</div>

<span class="n">logger</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">NoHTTPFilter</span><span class="p">())</span>

<div class="viewcode-block" id="lazy">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots.lazy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lazy</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Bot</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that lazily implements a function using an LLM at runtime.</span>

<span class="sd">    Use when you need to generate function implementations dynamically using an LLM.</span>
<span class="sd">    The implementation will be generated on first call and persisted to the source file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        prompt (Optional[str]): Additional instructions for the LLM about how to implement </span>
<span class="sd">            the function. Defaults to empty string.</span>
<span class="sd">        bot (Optional[Bot]): The bot instance to use for implementation. Defaults to </span>
<span class="sd">            a new AnthropicBot instance.</span>
<span class="sd">        context (Optional[str]): Level of context to provide to the LLM. Options are:</span>
<span class="sd">            - &#39;None&#39;: No additional context</span>
<span class="sd">            - &#39;low&#39;: Only the containing class</span>
<span class="sd">            - &#39;medium&#39;: The entire current file</span>
<span class="sd">            - &#39;high&#39;: Current file and interfaces of other files in directory</span>
<span class="sd">            - &#39;very high&#39;: All Python files in directory</span>
<span class="sd">            Defaults to &#39;None&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: A decorator function that wraps the target function</span>

<span class="sd">    Example:</span>
<span class="sd">        @lazy(&quot;Sort using a funny algorithm. Name variables as though you&#39;re a clown.&quot;)</span>
<span class="sd">        def sort(arr: list[int]) -&gt; list[int]:</span>
<span class="sd">            pass</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inner decorator function that sets up the lazy implementation.</span>
<span class="sd">        </span>
<span class="sd">        This decorator initializes the lazy implementation environment by:</span>
<span class="sd">        1. Setting up default bot if none provided</span>
<span class="sd">        2. Setting up default prompt if none provided</span>
<span class="sd">        3. Setting up default context level if none provided</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">            func (Callable): The function to be lazily implemented</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Callable: A wrapped version of the function that will be implemented on first call</span>
<span class="sd">            </span>
<span class="sd">        Note:</span>
<span class="sd">            The actual implementation is generated in the wrapper function on first call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">bot</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">context</span>
        <span class="k">if</span> <span class="n">bot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bot</span> <span class="o">=</span> <span class="n">AnthropicBot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claude&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Wrapper function that handles lazy function implementation.</span>
<span class="sd">            </span>
<span class="sd">            This wrapper checks if the function has been implemented. If not, it:</span>
<span class="sd">            1. Gets appropriate context based on context_level</span>
<span class="sd">            2. Generates implementation using the LLM</span>
<span class="sd">            3. Updates the source file with the new implementation</span>
<span class="sd">            4. Executes the new implementation</span>
<span class="sd">            </span>
<span class="sd">            Parameters:</span>
<span class="sd">                *args (Any): Positional arguments to pass to the implemented function</span>
<span class="sd">                **kwargs (Any): Keyword arguments to pass to the implemented function</span>
<span class="sd">                </span>
<span class="sd">            Returns:</span>
<span class="sd">                Any: The result of the implemented function</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">func</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="s1">&#39;initialized&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
                <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initializing lazy function: </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">context_content</span> <span class="o">=</span> <span class="n">_get_context</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">instructions</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Please fill out the following </span>
<span class="sd">                    function definition according to the following requirements. </span>
<span class="sd">                    Respond only with the code in a single code block. Include all </span>
<span class="sd">                    import statements inside the function definition. Remove the lazy </span>
<span class="sd">                    decorator. Respond only with the function definition, including </span>
<span class="sd">                    any new decorators and docstring. Include &#39;gen by @lazy&#39; in the </span>
<span class="sd">                    docstring. Use PEP8 convention with type hints for all variables.&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="n">complete_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">instructions</span><span class="si">}</span>

<span class="s2">                    </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>

<span class="s2">                    </span><span class="si">{</span><span class="n">context_content</span><span class="si">}</span>

<span class="s2">                    </span><span class="si">{</span><span class="n">function_name</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="n">complete_prompt</span><span class="p">)</span>
                <span class="n">function_code</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">remove_code_blocks</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">function_code</span> <span class="o">=</span> <span class="n">function_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated function code:</span><span class="se">\n</span><span class="si">{</span><span class="n">function_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Source file: </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">source_lines</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original source file content:</span><span class="se">\n</span><span class="si">{</span><span class="n">source_lines</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">source_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>

                <span class="k">class</span><span class="w"> </span><span class="nc">FunctionReplacer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;AST transformer that replaces a function definition with new code.</span>
<span class="sd">                    </span>
<span class="sd">                    This transformer walks the AST and replaces a specific function&#39;s</span>
<span class="sd">                    definition with new code while preserving the rest of the module.</span>
<span class="sd">                    </span>
<span class="sd">                    Attributes:</span>
<span class="sd">                        function_name (str): Name of the function to be replaced</span>
<span class="sd">                        new_code (str): New implementation code to replace the function with</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="o">=</span> <span class="n">function_name</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_code</span> <span class="o">=</span> <span class="n">new_code</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replacing function: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">new_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_code</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">return</span> <span class="n">new_node</span>
                        <span class="k">return</span> <span class="n">node</span>
                <span class="n">function_replacer</span> <span class="o">=</span> <span class="n">FunctionReplacer</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">function_code</span><span class="p">)</span>
                <span class="n">new_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="n">function_replacer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">source_tree</span><span class="p">)</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
                <span class="n">new_source_lines</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New source file content:</span><span class="se">\n</span><span class="si">{</span><span class="n">new_source_lines</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_source_lines</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updated source file written&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">function_code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">function_name</span><span class="p">]</span>
                <span class="n">wrapper</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lazy function </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> initialized&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="_get_context">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots._get_context">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_context</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">context_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves contextual code based on the specified context level.</span>

<span class="sd">    Use when you need to gather source code context for an LLM to understand </span>
<span class="sd">    the environment of a function.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        func (Callable): The function to get context for</span>
<span class="sd">        context_level (str): Level of context to retrieve:</span>
<span class="sd">            - &#39;None&#39;: Returns empty string</span>
<span class="sd">            - &#39;low&#39;: Returns only the containing class</span>
<span class="sd">            - &#39;medium&#39;: Returns entire current file</span>
<span class="sd">            - &#39;high&#39;: Returns current file and interfaces of other files</span>
<span class="sd">            - &#39;very high&#39;: Returns all Python files in directory</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The requested context as a string</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If context_level is not one of the valid options</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context_level</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">source_file</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">source_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context_level</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
        <span class="n">source_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source_code</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sub_node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sub_node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">context_level</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">context_level</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Current file (</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span><span class="si">}</span><span class="s1">):</span><span class="se">\n</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Interface of </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">_get_py_interface</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">context</span>
    <span class="k">elif</span> <span class="n">context_level</span> <span class="o">==</span> <span class="s1">&#39;very high&#39;</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">context</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid context level: </span><span class="si">{</span><span class="n">context_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_get_py_interface">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots._get_py_interface">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_py_interface</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts the public interface (classes and functions) from a Python file.</span>

<span class="sd">    Use when you need to get a high-level overview of a Python module&#39;s structure</span>
<span class="sd">    without including implementation details.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_path (str): Path to the Python file to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A string containing the module&#39;s interface, including class and function</span>
<span class="sd">            signatures with their docstrings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract docstring from an AST node.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            node (ast.AST): The AST node to extract docstring from</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The node&#39;s docstring or empty string if none exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_function</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format a function definition with its signature and docstring.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            node (ast.FunctionDef): The function definition node to format</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted string containing the function signature and docstring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;def </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">    &quot;&quot;&quot;</span><span class="si">{</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_class</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format a class definition with its signature, docstring, and method interfaces.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            node (ast.ClassDef): The class definition node to format</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted string containing the class definition, including base classes,</span>
<span class="sd">                docstring, and method signatures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">class_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;class </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">:</span>
            <span class="n">class_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">class_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">    &quot;&quot;&quot;</span><span class="si">{</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
                <span class="n">class_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    </span><span class="si">{</span><span class="n">format_function</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">class_str</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span>
            <span class="n">interface</span> <span class="o">+=</span> <span class="n">format_class</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
            <span class="n">interface</span> <span class="o">+=</span> <span class="n">format_function</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">interface</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>


<div class="viewcode-block" id="debug_on_error">
<a class="viewcode-back" href="../../../source/bots.dev.html#bots.debug_on_error">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">debug_on_error</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that launches post-mortem debugging on exception.</span>

<span class="sd">    Use when you need to automatically start a debugging session when a function </span>
<span class="sd">    raises an unhandled exception. This is particularly useful during development </span>
<span class="sd">    and troubleshooting.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        func (Callable): The function to wrap with debugging capabilities</span>

<span class="sd">    Returns:</span>
<span class="sd">        Callable: A wrapped version of the function that will launch pdb on error</span>

<span class="sd">    Example:</span>
<span class="sd">        @debug_on_error</span>
<span class="sd">        def might_fail():</span>
<span class="sd">            # If this raises an exception, you&#39;ll get a pdb prompt</span>
<span class="sd">            risky_operation()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- Entering post-mortem debugging ---&#39;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, benbuzz790.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>