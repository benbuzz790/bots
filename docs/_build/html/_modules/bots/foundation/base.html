

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bots.foundation.base &mdash; bots 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            bots
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bots</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bots.foundation.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bots.foundation.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Core foundation classes for the bots framework.</span>

<span class="sd">This module provides the fundamental abstractions and base classes that power the bots framework:</span>
<span class="sd">- Bot: Abstract base class for all LLM implementations</span>
<span class="sd">- ToolHandler: Manages function/module tools with context preservation</span>
<span class="sd">- ConversationNode: Tree-based conversation storage</span>
<span class="sd">- Mailbox: Abstract interface for LLM service communication</span>
<span class="sd">- Engines: Supported LLM model configurations</span>

<span class="sd">The classes in this module are designed to:</span>
<span class="sd">- Provide a consistent interface across different LLM implementations</span>
<span class="sd">- Enable sophisticated context and tool management</span>
<span class="sd">- Support complete bot portability and state preservation</span>
<span class="sd">- Handle conversation branching and context management efficiently</span>

<span class="sd">Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    from bots import AnthropicBot</span>
<span class="sd">    import my_tools</span>

<span class="sd">    # Create a bot with tools</span>
<span class="sd">    bot = AnthropicBot()</span>
<span class="sd">    bot.add_tools(my_tools)</span>
<span class="sd">    </span>
<span class="sd">    # Basic interaction</span>
<span class="sd">    response = bot.respond(&quot;Hello!&quot;)</span>
<span class="sd">    </span>
<span class="sd">    # Save bot state</span>
<span class="sd">    bot.save(&quot;my_bot.bot&quot;)</span>
<span class="sd">    ```</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">ast</span><span class="o">,</span><span class="w"> </span><span class="nn">inspect</span><span class="o">,</span><span class="w"> </span><span class="nn">hashlib</span><span class="o">,</span><span class="w"> </span><span class="nn">importlib</span><span class="o">,</span><span class="w"> </span><span class="nn">textwrap</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bots.utils.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">formatted_datetime</span><span class="p">,</span> <span class="n">_clean</span>

<div class="viewcode-block" id="load">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.load">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Bot&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a saved bot from a file.</span>

<span class="sd">    Use when you need to restore a previously saved bot with its complete state,</span>
<span class="sd">    including conversation history, tools, and configuration.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        filepath (str): Path to the .bot file containing the saved bot state</span>

<span class="sd">    Returns:</span>
<span class="sd">        Bot: A reconstructed Bot instance with the saved state</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        bot = bots.load(&quot;my_saved_bot.bot&quot;)</span>
<span class="sd">        bot.respond(&quot;Continue our previous conversation&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Bot</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>



<div class="viewcode-block" id="Engines">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Engines">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Engines</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enum class representing different AI model engines.&quot;&quot;&quot;</span>
    <span class="n">GPT4</span> <span class="o">=</span> <span class="s1">&#39;gpt-4&#39;</span>
    <span class="n">GPT4_0613</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-0613&#39;</span>
    <span class="n">GPT4_32K</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-32k&#39;</span>
    <span class="n">GPT4_32K_0613</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-32k-0613&#39;</span>
    <span class="n">GPT4TURBO</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-turbo-preview&#39;</span>
    <span class="n">GPT4TURBO_0125</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-0125-preview&#39;</span>
    <span class="n">GPT4TURBO_VISION</span> <span class="o">=</span> <span class="s1">&#39;gpt-4-vision-preview&#39;</span>
    <span class="n">GPT35TURBO</span> <span class="o">=</span> <span class="s1">&#39;gpt-3.5-turbo&#39;</span>
    <span class="n">GPT35TURBO_16K</span> <span class="o">=</span> <span class="s1">&#39;gpt-3.5-turbo-16k&#39;</span>
    <span class="n">GPT35TURBO_0125</span> <span class="o">=</span> <span class="s1">&#39;gpt-3.5-turbo-0125&#39;</span>
    <span class="n">GPT35TURBO_INSTRUCT</span> <span class="o">=</span> <span class="s1">&#39;gpt-3.5-turbo-instruct&#39;</span>
    <span class="n">CLAUDE3_HAIKU</span> <span class="o">=</span> <span class="s1">&#39;claude-3-haiku-20240307&#39;</span>
    <span class="n">CLAUDE3_SONNET</span> <span class="o">=</span> <span class="s1">&#39;claude-3-sonnet-20240229&#39;</span>
    <span class="n">CLAUDE3_OPUS</span> <span class="o">=</span> <span class="s1">&#39;claude-3-opus-20240229&#39;</span>
    <span class="n">CLAUDE35_SONNET_20240620</span> <span class="o">=</span> <span class="s1">&#39;claude-3-5-sonnet-20240620&#39;</span>
    <span class="n">CLAUDE35_SONNET_20241022</span> <span class="o">=</span> <span class="s1">&#39;claude-3-5-sonnet-20241022&#39;</span>
    <span class="n">CLAUDE37_SONNET_20250219</span> <span class="o">=</span> <span class="s1">&#39;claude-3-7-sonnet-20250219&#39;</span>

<div class="viewcode-block" id="Engines.get">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Engines.get">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Engines&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve an Engines enum member by its string value.</span>

<span class="sd">        Use when you need to convert a model name string to an Engines enum member.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            name (str): The string value of the engine (e.g., &#39;gpt-4&#39;, &#39;claude-3-opus-20240229&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[Engines]: The corresponding Engines enum member, or None if not found</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            engine = Engines.get(&#39;gpt-4&#39;)</span>
<span class="sd">            if engine:</span>
<span class="sd">                bot = Bot(model_engine=engine)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">engine</span> <span class="ow">in</span> <span class="n">Engines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">engine</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Engines.get_bot_class">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Engines.get_bot_class">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bot_class</span><span class="p">(</span><span class="n">model_engine</span><span class="p">:</span> <span class="s1">&#39;Engines&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;Bot&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the appropriate Bot subclass for a given model engine.</span>

<span class="sd">        Use when you need to programmatically determine which Bot implementation</span>
<span class="sd">        to use for a specific model engine.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            model_engine (Engines): The engine enum member to get the bot class for</span>

<span class="sd">        Returns:</span>
<span class="sd">            Type[Bot]: The Bot subclass (ChatGPT_Bot or AnthropicBot)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the model engine is not supported</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            bot_class = Engines.get_bot_class(Engines.GPT4)</span>
<span class="sd">            bot = bot_class(api_key=&quot;key&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bots.foundation.openai_bots</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatGPT_Bot</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bots.foundation.anthropic_bots</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnthropicBot</span>
        <span class="k">if</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gpt&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ChatGPT_Bot</span>
        <span class="k">elif</span> <span class="n">model_engine</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;claude&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AnthropicBot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported model engine: </span><span class="si">{</span><span class="n">model_engine</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Engines.get_conversation_node_class">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Engines.get_conversation_node_class">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_node_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;ConversationNode&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the appropriate ConversationNode subclass by name.</span>

<span class="sd">        Use when you need to reconstruct conversation nodes from saved bot state.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            class_name (str): Name of the node class (&#39;OpenAINode&#39; or &#39;AnthropicNode&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Type[ConversationNode]: The ConversationNode subclass</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the class name is not a supported node type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bots.foundation.openai_bots</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAINode</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bots.foundation.anthropic_bots</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnthropicNode</span>
        <span class="n">NODE_CLASS_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OpenAINode&#39;</span><span class="p">:</span> <span class="n">OpenAINode</span><span class="p">,</span> <span class="s1">&#39;AnthropicNode&#39;</span><span class="p">:</span> <span class="n">AnthropicNode</span><span class="p">}</span>
        <span class="n">node_class</span> <span class="o">=</span> <span class="n">NODE_CLASS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported conversation node type: </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node_class</span></div>
</div>


<div class="viewcode-block" id="ConversationNode">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConversationNode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tree-based storage for conversation history and tool interactions.</span>

<span class="sd">    ConversationNode implements a linked tree structure that enables sophisticated</span>
<span class="sd">    conversation management, including branching conversations and tool usage tracking.</span>
<span class="sd">    Each node represents a message in the conversation and can have multiple replies,</span>
<span class="sd">    forming a tree structure.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        role (str): The role of the message sender (&#39;user&#39;, &#39;assistant&#39;, etc.)</span>
<span class="sd">        content (str): The message content</span>
<span class="sd">        parent (ConversationNode): Reference to the parent node</span>
<span class="sd">        replies (List[ConversationNode]): List of reply nodes</span>
<span class="sd">        tool_calls (List[Dict]): Tool invocations made in this message</span>
<span class="sd">        tool_results (List[Dict]): Results from tool executions</span>
<span class="sd">        pending_results (List[Dict]): Tool results waiting to be processed</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        # Create a conversation tree</span>
<span class="sd">        root = ConversationNode(role=&#39;user&#39;, content=&#39;Hello&#39;)</span>
<span class="sd">        response = root._add_reply(role=&#39;assistant&#39;, content=&#39;Hi there!&#39;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConversationNode.__init__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">tool_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pending_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new ConversationNode.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            content (str): The message content</span>
<span class="sd">            role (str): The role of the message sender</span>
<span class="sd">            tool_calls (Optional[List[Dict]]): Tool invocations made in this message</span>
<span class="sd">            tool_results (Optional[List[Dict]]): Results from tool executions</span>
<span class="sd">            pending_results (Optional[List[Dict]]): Tool results waiting to be processed</span>
<span class="sd">            **kwargs: Additional attributes to set on the node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span> <span class="n">ConversationNode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConversationNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span> <span class="o">=</span> <span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_results</span> <span class="o">=</span> <span class="n">tool_results</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span> <span class="o">=</span> <span class="n">pending_results</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConversationNode._create_empty">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._create_empty">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;ConversationNode&#39;</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ConversationNode&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an empty root node.</span>

<span class="sd">        Use when initializing a new conversation tree that needs an empty root.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cls (Optional[Type[ConversationNode]]): Optional specific node class to use</span>

<span class="sd">        Returns:</span>
<span class="sd">            ConversationNode: An empty node with role=&#39;empty&#39; and no content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConversationNode</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConversationNode._is_empty">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._is_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is an empty root node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if this is an empty root node, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;empty&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="ConversationNode._add_reply">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._add_reply">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ConversationNode&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new reply node to this conversation node.</span>

<span class="sd">        Creates a new node as a child of this one, handling tool context</span>
<span class="sd">        synchronization between siblings.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            **kwargs: Attributes to set on the new node (content, role, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            ConversationNode: The newly created reply node</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            node = root._add_reply(content=&quot;Hello&quot;, role=&quot;user&quot;)</span>
<span class="sd">            response = node._add_reply(content=&quot;Hi!&quot;, role=&quot;assistant&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">reply</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">:</span>
            <span class="n">reply</span><span class="o">.</span><span class="n">tool_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reply</span><span class="o">.</span><span class="n">_sync_tool_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>



<div class="viewcode-block" id="ConversationNode._sync_tool_context">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._sync_tool_context">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_tool_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize tool results across all sibling nodes.</span>

<span class="sd">        Use when tool results need to be shared between parallel conversation branches.</span>
<span class="sd">        Takes the union of all tool results from sibling nodes and ensures each sibling</span>
<span class="sd">        has access to all results.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            Updates tool_results for all sibling nodes to include all unique results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
            <span class="n">all_tool_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sibling</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">sibling</span><span class="o">.</span><span class="n">tool_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_tool_results</span><span class="p">:</span>
                        <span class="n">all_tool_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sibling</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                <span class="n">sibling</span><span class="o">.</span><span class="n">tool_results</span> <span class="o">=</span> <span class="n">all_tool_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConversationNode._add_tool_calls">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._add_tool_calls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tool call records to this node.</span>

<span class="sd">        Use when new tool calls are made during the conversation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            calls (List[Dict[str, Any]]): List of tool call records to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">calls</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConversationNode._add_tool_results">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._add_tool_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_tool_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tool execution results to this node.</span>

<span class="sd">        Use when tool execution results are received and need to be recorded.</span>
<span class="sd">        Automatically synchronizes results with sibling nodes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            results (List[Dict[str, Any]]): List of tool result records to add</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Updates this node&#39;s tool_results</span>
<span class="sd">            - Synchronizes results across sibling nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_tool_context</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConversationNode._find_root">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._find_root">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_root</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ConversationNode&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Navigate to the root node of the conversation tree.</span>

<span class="sd">        Use when you need to access the starting point of the conversation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ConversationNode: The root node of the conversation tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="n">current</span></div>


<div class="viewcode-block" id="ConversationNode._root_dict">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._root_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_root_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the entire conversation tree to a dictionary.</span>

<span class="sd">        Use when serializing the complete conversation for saving or transmission.</span>
<span class="sd">        Starts from the root node and includes all branches.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary representation of the complete conversation tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_root</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">_to_dict_recursive</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConversationNode._to_dict_recursive">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._to_dict_recursive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_dict_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively convert this node and all its replies to a dictionary.</span>

<span class="sd">        Use when you need to serialize a subtree of the conversation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing this node and all its descendants</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict_self</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;replies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">reply</span><span class="o">.</span><span class="n">_to_dict_recursive</span><span class="p">()</span> <span class="k">for</span> <span class="n">reply</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replies</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ConversationNode._to_dict_self">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._to_dict_self">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_dict_self</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert just this node to a dictionary.</span>

<span class="sd">        Use when serializing a single conversation node.</span>
<span class="sd">        Omits replies, parent references, and callable attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing this node&#39;s attributes</span>

<span class="sd">        Note:</span>
<span class="sd">            Only serializes basic types (str, int, float, bool, list, dict)</span>
<span class="sd">            and converts other types to strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;replies&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;node_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ConversationNode._build_messages">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._build_messages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a chronological list of messages from root to this node.</span>

<span class="sd">        Use when you need to construct the conversation history for an LLM API call.</span>
<span class="sd">        Includes tool calls and results in each message where present.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of message dictionaries, each containing:</span>
<span class="sd">                - role: The message sender&#39;s role</span>
<span class="sd">                - content: The message text</span>
<span class="sd">                - tool_calls: (optional) List of tool calls made</span>
<span class="sd">                - tool_results: (optional) List of tool execution results</span>

<span class="sd">        Note:</span>
<span class="sd">            Empty root nodes are excluded from the message list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_is_empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">conversation_list_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">_is_empty</span><span class="p">():</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">content</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tool_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span>
                <span class="n">conversation_list_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">+</span> <span class="n">conversation_list_dict</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="n">conversation_list_dict</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;ConversationNode&#39;</span><span class="p">:</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;replies&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">node_class</span> <span class="o">=</span> <span class="n">Engines</span><span class="o">.</span><span class="n">get_conversation_node_class</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;node_class&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node_class</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reply</span> <span class="ow">in</span> <span class="n">reply_data</span><span class="p">:</span>
            <span class="n">reply_node</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
            <span class="n">reply_node</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">node</span><span class="o">.</span><span class="n">replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

<div class="viewcode-block" id="ConversationNode._node_count">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ConversationNode._node_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_node_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count the total number of nodes in the conversation tree.</span>

<span class="sd">        Use when you need to measure the size of the conversation.</span>
<span class="sd">        Counts from the root node down through all branches.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Total number of nodes in the conversation tree</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            total_messages = node._node_count()</span>
<span class="sd">            print(f&quot;This conversation has {total_messages} messages&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_root</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">count_recursive</span><span class="p">(</span><span class="n">current_node</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">reply</span> <span class="ow">in</span> <span class="n">current_node</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="n">count_recursive</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">count_recursive</span><span class="p">(</span><span class="n">root</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ModuleContext">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ModuleContext">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModuleContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context container for module-level tool preservation.</span>

<span class="sd">    Stores all necessary information to reconstruct a module and its tools,</span>
<span class="sd">    including source code, namespace, and execution environment.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The module&#39;s name</span>
<span class="sd">        source (str): The module&#39;s complete source code</span>
<span class="sd">        file_path (str): Original file path or generated path for dynamic modules</span>
<span class="sd">        namespace (ModuleType): The module&#39;s execution namespace</span>
<span class="sd">        code_hash (str): Hash of the source code for version checking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">ModuleType</span>
    <span class="n">code_hash</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="ToolHandlerError">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandlerError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolHandlerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception class for ToolHandler errors.</span>

<span class="sd">    Use as a base class for all tool-related exceptions to allow</span>
<span class="sd">    specific error handling for tool operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ToolNotFoundError">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolNotFoundError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolNotFoundError</span><span class="p">(</span><span class="n">ToolHandlerError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a requested tool is not available.</span>

<span class="sd">    Use when attempting to use a tool that hasn&#39;t been registered</span>
<span class="sd">    with the ToolHandler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ModuleLoadError">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ModuleLoadError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ModuleLoadError</span><span class="p">(</span><span class="n">ToolHandlerError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a module cannot be loaded for tool extraction.</span>

<span class="sd">    Use when there are issues loading a module&#39;s source code,</span>
<span class="sd">    executing it in a new namespace, or extracting its tools.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ToolHandler">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolHandler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for managing bot tool operations.</span>

<span class="sd">    ToolHandler provides a complete system for:</span>
<span class="sd">    - Registering Python functions as bot tools</span>
<span class="sd">    - Preserving tool context and dependencies</span>
<span class="sd">    - Managing tool execution and results</span>
<span class="sd">    - Serializing and deserializing tool state</span>

<span class="sd">    The class supports both individual function tools and complete module imports,</span>
<span class="sd">    preserving all necessary context for tool operation across bot save/load cycles.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tools (List[Dict[str, Any]]): Registered tool schemas</span>
<span class="sd">        function_map (Dict[str, Callable]): Mapping of tool names to functions</span>
<span class="sd">        requests (List[Dict[str, Any]]): Pending tool execution requests</span>
<span class="sd">        results (List[Dict[str, Any]]): Results from tool executions</span>
<span class="sd">        modules (Dict[str, ModuleContext]): Module contexts for imported tools</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyToolHandler(ToolHandler):</span>
<span class="sd">            # Implement abstract methods...</span>
<span class="sd">            pass</span>

<span class="sd">        handler = MyToolHandler()</span>
<span class="sd">        handler.add_tools(my_module)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ToolHandler.__init__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModuleContext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ToolHandler.generate_tool_schema">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.generate_tool_schema">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_tool_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the tool schema for the bot&#39;s api. Must be implemented per provider.</span>

<span class="sd">        Use to create a consistent tool description that the LLM can understand.</span>
<span class="sd">        Must extract relevant information from the function&#39;s signature and docstring.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            func (Callable): The function to generate a schema for</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Schema describing the tool&#39;s:</span>
<span class="sd">                - name and description</span>
<span class="sd">                - parameters and their types</span>
<span class="sd">                - return value format</span>
<span class="sd">                - usage instructions</span>

<span class="sd">        Example Schema:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: &quot;calculate_area&quot;,</span>
<span class="sd">                &quot;description&quot;: &quot;Calculate the area of a circle&quot;,</span>
<span class="sd">                &quot;parameters&quot;: {</span>
<span class="sd">                    &quot;radius&quot;: {&quot;type&quot;: &quot;float&quot;, &quot;description&quot;: &quot;Circle radius&quot;}</span>
<span class="sd">                },</span>
<span class="sd">                &quot;returns&quot;: &quot;float: The calculated area&quot;</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.generate_request_schema">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.generate_request_schema">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_request_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract tool requests from an LLM response. Must be implemented per provider.</span>

<span class="sd">        Use to parse the LLM&#39;s response and identify any tool usage requests.</span>
<span class="sd">        Multiple tool requests may be present in a single response.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            response (Any): Raw response from the LLM service</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of parsed tool request schemas, each containing:</span>
<span class="sd">                - Specific requirements per provider</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            response = llm_service.get_response()</span>
<span class="sd">            requests = handler.generate_request_schema(response)</span>
<span class="sd">            # [{&quot;name&quot;: &quot;view_file&quot;, &quot;parameters&quot;: {&quot;path&quot;: &quot;main.py&quot;}}, ...]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.tool_name_and_input">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.tool_name_and_input">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_name_and_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract tool name and parameters from a request schema. Must be implemented per provider.</span>

<span class="sd">        Use to parse a tool request into components that can be used for execution.</span>
<span class="sd">        Validates and prepares the input parameters for the tool function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request_schema (Dict[str, Any]): The request schema to parse</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Optional[str], Dict[str, Any]]:</span>
<span class="sd">                - Tool name (or None if request should be skipped)</span>
<span class="sd">                - Dictionary of prepared input parameters</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            name, params = handler.tool_name_and_input({</span>
<span class="sd">                &quot;name&quot;: &quot;calculate_area&quot;,</span>
<span class="sd">                &quot;parameters&quot;: {&quot;radius&quot;: &quot;5.0&quot;}</span>
<span class="sd">            })</span>
<span class="sd">            if name:</span>
<span class="sd">                result = handler.function_map[name](**params)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.generate_response_schema">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.generate_response_schema">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_response_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_output_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a response schema from tool execution results. Must be implemented per provider.</span>

<span class="sd">        Use to format tool output in a way the LLM can understand and process.</span>
<span class="sd">        Maintains connection between request and response through request metadata.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request (Dict[str, Any]): The original request schema</span>
<span class="sd">            tool_output_kwargs (Dict[str, Any]): The tool&#39;s execution results</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Formatted response schema containing:</span>
<span class="sd">                - Specific Schema for provider</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            result = tool_func(**params)</span>
<span class="sd">            response = handler.generate_response_schema(request, result)</span>
<span class="sd">            # {&quot;tool_name&quot;: &quot;view_file&quot;, &quot;status&quot;: &quot;success&quot;, &quot;content&quot;: &quot;file contents...&quot;}</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.generate_error_schema">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.generate_error_schema">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_error_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an error response schema. Must be implemented per provider.</span>

<span class="sd">        Use to format error messages in a way the LLM can understand and handle appropriately.</span>
<span class="sd">        Should maintain consistency with successful response schemas.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request_schema (Dict[str, Any]): The request that caused the error</span>
<span class="sd">            error_msg (str): The error message to include</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Error response schema containing:</span>
<span class="sd">                - Required schema per provider</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            try:</span>
<span class="sd">                result = tool_func(**params)</span>
<span class="sd">            except Exception as e:</span>
<span class="sd">                error = handler.generate_error_schema(request, str(e))</span>
<span class="sd">                # {&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;File not found&quot;, &quot;type&quot;: &quot;FileNotFoundError&quot;}</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ToolHandler.extract_requests">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.extract_requests">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract and parse tool requests from an LLM response.</span>

<span class="sd">        Use when you need to identify and process tool usage requests</span>
<span class="sd">        from a raw LLM response.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            response (Any): The raw response from the LLM service</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of parsed request schemas</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Clears existing self.requests</span>
<span class="sd">            - Sets self.requests to the newly parsed requests</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            requests = handler.extract_requests(llm_response)</span>
<span class="sd">            # [{&quot;name&quot;: &quot;view_file&quot;, &quot;parameters&quot;: {...}}, ...]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_request_schema</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span></div>


<div class="viewcode-block" id="ToolHandler.exec_requests">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.exec_requests">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exec_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute pending tool requests and generate results.</span>

<span class="sd">        Use when you need to process all pending tool requests that have been</span>
<span class="sd">        extracted from an LLM response. Handles execution, error handling,</span>
<span class="sd">        and result formatting.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of result schemas, each containing:</span>
<span class="sd">                - Tool execution results or error information</span>
<span class="sd">                - Status of the execution</span>
<span class="sd">                - Any relevant metadata</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Executes tool functions with provided parameters</span>
<span class="sd">            - Updates self.results with execution results</span>
<span class="sd">            - May produce tool-specific side effects (file operations, etc.)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ToolNotFoundError: If a requested tool is not available</span>
<span class="sd">            TypeError: If tool arguments are invalid</span>
<span class="sd">            Exception: For other tool execution errors</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            handler.extract_requests(response)</span>
<span class="sd">            results = handler.exec_requests()</span>
<span class="sd">            # [{&quot;status&quot;: &quot;success&quot;, &quot;content&quot;: &quot;file contents...&quot;}, ...]</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span>
        <span class="k">for</span> <span class="n">request_schema</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
            <span class="n">tool_name</span><span class="p">,</span> <span class="n">input_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_name_and_input</span><span class="p">(</span><span class="n">request_schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ToolNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; not found in function map&quot;</span><span class="p">)</span>
                <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
                <span class="n">output_kwargs</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">input_kwargs</span><span class="p">)</span>
                <span class="n">response_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_response_schema</span><span class="p">(</span><span class="n">request_schema</span><span class="p">,</span> <span class="n">output_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ToolNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;Error: Tool not found.</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">response_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_error_schema</span><span class="p">(</span><span class="n">request_schema</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid arguments for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">response_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_error_schema</span><span class="p">(</span><span class="n">request_schema</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error while executing tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">response_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_error_schema</span><span class="p">(</span><span class="n">request_schema</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_schema</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="ToolHandler._create_builtin_wrapper">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler._create_builtin_wrapper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_builtin_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a wrapper function source code for built-in functions.</span>

<span class="sd">        Use when adding built-in Python functions as tools. Creates a wrapper</span>
<span class="sd">        that maintains proper type handling and module context.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            func (Callable): The built-in function to wrap</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Source code for the wrapper function</span>

<span class="sd">        Note:</span>
<span class="sd">            - Automatically handles float conversion for numeric functions</span>
<span class="sd">            - Preserves original module context</span>
<span class="sd">            - Maintains function name and basic documentation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;def </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(x):</span><span class="se">\n</span><span class="s1">    &quot;&quot;&quot;Wrapper for built-in function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">    import </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="se">\n</span><span class="s1">    return </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(float(x))</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">source</span></div>


<div class="viewcode-block" id="ToolHandler._create_dynamic_wrapper">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler._create_dynamic_wrapper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_dynamic_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a wrapper function source code for dynamic or lambda functions.</span>

<span class="sd">        Use when adding functions that don&#39;t have accessible source code or</span>
<span class="sd">        are dynamically created.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            func (Callable): The function to create a wrapper for</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Source code for the wrapper function</span>

<span class="sd">        Note:</span>
<span class="sd">            - Preserves function signature if available</span>
<span class="sd">            - Copies docstring if present</span>
<span class="sd">            - Creates fallback implementation if source is not accessible</span>
<span class="sd">            - Handles both normal and dynamic functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;def </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}{</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    &quot;&quot;&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__code__&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="n">body</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;    return func(*args, **kwargs)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="s1">&#39;    pass</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">source</span></div>


<div class="viewcode-block" id="ToolHandler.add_tool">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.add_tool">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a single Python function as a tool for LLM use.</span>

<span class="sd">        Use when you need to make an individual function available as a tool.</span>
<span class="sd">        Handles all necessary context preservation and function wrapping.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            func (Callable): The function to add as a tool</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If tool schema generation fails</span>
<span class="sd">            TypeError: If function source cannot be accessed</span>
<span class="sd">            OSError: If there are issues accessing function source</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Creates module context if none exists</span>
<span class="sd">            - Adds function to tool registry</span>
<span class="sd">            - Updates function map</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            def calculate_area(radius: float) -&gt; float:</span>
<span class="sd">                &#39;&#39;&#39;Calculate circle area. Use when...&#39;&#39;&#39;</span>
<span class="sd">                return 3.14159 * radius * radius</span>

<span class="sd">            handler.add_tool(calculate_area)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Preserves function&#39;s full context including docstring</span>
<span class="sd">            - Creates wrappers for built-in and dynamic functions</span>
<span class="sd">            - Maintains all necessary dependencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_tool_schema</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Schema undefined. ToolHandler.generate_tool_schema() may not be implemented.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__module_context__&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isbuiltin</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethoddescriptor</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_builtin_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__globals__&#39;</span><span class="p">):</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_names</span>
                        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dynamic_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">_clean</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dynamic_module_</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dynamic_module_</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">ModuleType</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">file_path</span>
            <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">module_context</span> <span class="o">=</span> <span class="n">ModuleContext</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">code_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_code_hash</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="n">new_func</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
            <span class="n">new_func</span><span class="o">.</span><span class="n">__module_context__</span> <span class="o">=</span> <span class="n">module_context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_context</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">new_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span></div>


<div class="viewcode-block" id="ToolHandler._add_tools_from_file">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler._add_tools_from_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_tools_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add all non-private functions from a Python file as tools.</span>

<span class="sd">        Use when you want to add all suitable functions from a Python file.</span>
<span class="sd">        Handles module loading, dependency preservation, and context management.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filepath (str): Path to the Python file containing tool functions</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the specified file doesn&#39;t exist</span>
<span class="sd">            ModuleLoadError: If there&#39;s an error loading the module or its dependencies</span>
<span class="sd">            SyntaxError: If the Python file contains syntax errors</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Creates module context for the file</span>
<span class="sd">            - Adds all non-private functions as tools</span>
<span class="sd">            - Preserves module dependencies and imports</span>
<span class="sd">            - Updates module registry</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            handler._add_tools_from_file(&quot;path/to/tools.py&quot;)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Only adds top-level functions (not nested in classes/functions)</span>
<span class="sd">            - Skips functions whose names start with underscore</span>
<span class="sd">            - Maintains original module context for all functions</span>
<span class="sd">            - Preserves source code for serialization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
        <span class="n">abs_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dynamic_module_</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">abs_file_path</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">ModuleType</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">abs_file_path</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">function_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)]</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">module_context</span> <span class="o">=</span> <span class="n">ModuleContext</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">abs_file_path</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">code_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_code_hash</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">abs_file_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_context</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">function_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                        <span class="n">func</span><span class="o">.</span><span class="n">__module_context__</span> <span class="o">=</span> <span class="n">module_context</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_tool</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModuleLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading module from </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="ToolHandler._add_tools_from_module">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler._add_tools_from_module">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_tools_from_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">ModuleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add all non-private functions from a Python module as tools.</span>

<span class="sd">        Use when you want to add functions from an imported module or</span>
<span class="sd">        dynamically created module object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            module (ModuleType): Module object containing the tool functions</span>

<span class="sd">        Raises:</span>
<span class="sd">            ModuleLoadError: If module lacks both __file__ and __source__ attributes</span>
<span class="sd">            ImportError: If module dependencies cannot be resolved</span>
<span class="sd">            Exception: For other module processing errors</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Creates module context if needed</span>
<span class="sd">            - Adds all non-private functions as tools</span>
<span class="sd">            - Updates module registry</span>
<span class="sd">            - Preserves module state and dependencies</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            import my_tools</span>
<span class="sd">            handler._add_tools_from_module(my_tools)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Module must have either __file__ or __source__ attribute</span>
<span class="sd">            - Only processes top-level functions</span>
<span class="sd">            - Skips functions whose names start with underscore</span>
<span class="sd">            - Maintains complete module context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tools_from_file</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__source__&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__source__</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dynamic_module_</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dynamic_module</span> <span class="o">=</span> <span class="n">ModuleType</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="n">dynamic_module</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dynamic_module_</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dynamic_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                <span class="n">module_context</span> <span class="o">=</span> <span class="n">ModuleContext</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">dynamic_module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">dynamic_module</span><span class="p">,</span> <span class="n">code_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_code_hash</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">dynamic_module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_context</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">dynamic_module</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                        <span class="n">func</span><span class="o">.</span><span class="n">__module_context__</span> <span class="o">=</span> <span class="n">module_context</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_tool</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModuleLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading module </span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModuleLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module </span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> has neither file path nor source. Cannot load.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.to_dict">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize the complete ToolHandler state to a dictionary.</span>

<span class="sd">        Use when you need to save or transmit the tool handler&#39;s state,</span>
<span class="sd">        including all tools, modules, and execution state.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Serialized state containing:</span>
<span class="sd">                - Handler class information</span>
<span class="sd">                - Registered tools and their schemas</span>
<span class="sd">                - Module contexts and source code</span>
<span class="sd">                - Function mappings and relationships</span>
<span class="sd">                - Current requests and results</span>

<span class="sd">        Note:</span>
<span class="sd">            - Preserves complete module contexts</span>
<span class="sd">            - Handles both file-based and dynamic modules</span>
<span class="sd">            - Includes function source code for reconstruction</span>
<span class="sd">            - Maintains tool relationships and dependencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">function_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">module_context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">module_details</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">module_context</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">module_context</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">module_context</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;code_hash&#39;</span><span class="p">:</span> <span class="n">module_context</span><span class="o">.</span><span class="n">code_hash</span><span class="p">,</span> <span class="s1">&#39;globals&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">module_context</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)}}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">module_context</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__module_context__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_context</span><span class="p">:</span>
                <span class="n">function_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_context</span><span class="o">.</span><span class="n">file_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">function_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dynamic&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;requests&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;modules&#39;</span><span class="p">:</span> <span class="n">module_details</span><span class="p">,</span> <span class="s1">&#39;function_paths&#39;</span><span class="p">:</span> <span class="n">function_paths</span><span class="p">}</span></div>


<div class="viewcode-block" id="ToolHandler.from_dict">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;ToolHandler&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct a ToolHandler instance from serialized state.</span>

<span class="sd">        Use when restoring a previously serialized tool handler,</span>
<span class="sd">        such as when loading a saved bot state.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            data (Dict[str, Any]): Serialized state from to_dict()</span>

<span class="sd">        Returns:</span>
<span class="sd">            ToolHandler: Reconstructed handler instance</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Creates new module contexts</span>
<span class="sd">            - Reconstructs function objects</span>
<span class="sd">            - Restores tool registry</span>
<span class="sd">            - Preserves request/result history</span>

<span class="sd">        Note:</span>
<span class="sd">            - Only restores explicitly registered tools</span>
<span class="sd">            - Verifies code hashes for security</span>
<span class="sd">            - Maintains original module structure</span>
<span class="sd">            - Preserves execution state (requests/results)</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            saved_state = handler.to_dict()</span>
<span class="sd">            # Later...</span>
<span class="sd">            new_handler = ToolHandler.from_dict(saved_state)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">function_paths</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function_paths&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">module_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_code_hash</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_code_hash</span><span class="p">(</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">current_code_hash</span> <span class="o">!=</span> <span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;code_hash&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: Code hash mismatch for module </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">. Skipping.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">ModuleType</span><span class="p">(</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">file_path</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;globals&#39;</span> <span class="ow">in</span> <span class="n">module_data</span><span class="p">:</span>
                    <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;globals&#39;</span><span class="p">])</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                <span class="n">module_context</span> <span class="o">=</span> <span class="n">ModuleContext</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">code_hash</span><span class="o">=</span><span class="n">current_code_hash</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">module_context</span>
                <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">function_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">module_data</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                            <span class="n">func</span><span class="o">.</span><span class="n">__module_context__</span> <span class="o">=</span> <span class="n">module_context</span>
                            <span class="n">handler</span><span class="o">.</span><span class="n">function_map</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: Failed to load module </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">handler</span></div>


<div class="viewcode-block" id="ToolHandler.get_tools_json">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.get_tools_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tools_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a JSON string representation of all registered tools.</span>

<span class="sd">        Use when you need a serialized view of the available tools,</span>
<span class="sd">        such as for debugging or external tool discovery.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: JSON string containing all tool schemas, formatted with indentation</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            tools_json = handler.get_tools_json()</span>
<span class="sd">            print(f&quot;Available tools: {tools_json}&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.clear">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.clear">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all stored tool results and requests.</span>

<span class="sd">        Use when you need to reset the handler&#39;s execution state</span>
<span class="sd">        without affecting the registered tools.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Empties self.results list</span>
<span class="sd">            - Empties self.requests list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ToolHandler.add_request">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.add_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new tool request to the pending requests.</span>

<span class="sd">        Use when manually adding a tool request rather than</span>
<span class="sd">        extracting it from an LLM response.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request (Dict[str, Any]): Tool request schema to add</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Appends request to self.requests list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.add_result">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.add_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new tool result to the stored results.</span>

<span class="sd">        Use when manually adding a tool result rather than</span>
<span class="sd">        generating it through exec_requests().</span>

<span class="sd">        Parameters:</span>
<span class="sd">            result (Dict[str, Any]): Tool result schema to add</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Appends result to self.results list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="ToolHandler.get_results">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.get_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all stored tool execution results.</span>

<span class="sd">        Use when you need to access the complete history of</span>
<span class="sd">        tool execution results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of all tool result schemas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span></div>


<div class="viewcode-block" id="ToolHandler.get_requests">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.get_requests">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all stored tool requests.</span>

<span class="sd">        Use when you need to access the complete history of</span>
<span class="sd">        tool execution requests.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of all tool request schemas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span></div>


<div class="viewcode-block" id="ToolHandler._get_code_hash">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler._get_code_hash">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_code_hash</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an MD5 hash of a code string.</span>

<span class="sd">        Use when creating a unique identifier for code content</span>
<span class="sd">        or verifying code integrity during deserialization.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            code (str): Source code string to hash</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: MD5 hash of the code string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="ToolHandler.__str__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a simple string representation of the ToolHandler.</span>

<span class="sd">        Use when you need a quick overview of the handler&#39;s state,</span>
<span class="sd">        showing just the number of tools and modules.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Brief summary string showing tool and module counts</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            handler = ToolHandler()</span>
<span class="sd">            print(handler)  # &quot;ToolHandler with 5 tools and 2 modules&quot;</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ToolHandler with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span><span class="si">}</span><span class="s1"> tools and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span><span class="si">}</span><span class="s1"> modules&#39;</span></div>


<div class="viewcode-block" id="ToolHandler.__repr__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.ToolHandler.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a detailed string representation of the ToolHandler.</span>

<span class="sd">        Use when you need a complete technical view of the handler&#39;s state,</span>
<span class="sd">        including all tool names and module paths.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Detailed string showing:</span>
<span class="sd">                - List of all registered tool names</span>
<span class="sd">                - List of all module paths</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            handler = ToolHandler()</span>
<span class="sd">            print(repr(handler))  # Shows all tools and modules</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tool_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ToolHandler(tools=</span><span class="si">{</span><span class="n">tool_names</span><span class="si">}</span><span class="s1">, modules=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">)&#39;</span></div>
</div>


<div class="viewcode-block" id="Mailbox">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Mailbox">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Mailbox</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for LLM service communication.</span>

<span class="sd">    Mailbox provides a standardized interface for sending messages to and receiving</span>
<span class="sd">    responses from different LLM services (OpenAI, Anthropic, etc.). It handles:</span>
<span class="sd">    - Message formatting and sending</span>
<span class="sd">    - Response parsing and processing</span>
<span class="sd">    - Logging of all communications</span>
<span class="sd">    - Tool result integration</span>

<span class="sd">    The class abstracts away the differences between various LLM APIs,</span>
<span class="sd">    providing a consistent interface for the Bot class.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class AnthropicMailbox(Mailbox):</span>
<span class="sd">            def send_message(self, bot):</span>
<span class="sd">                # Implementation for Anthropic API</span>
<span class="sd">                pass</span>

<span class="sd">            def process_response(self, response, bot=None):</span>
<span class="sd">                # Parse Anthropic response format</span>
<span class="sd">                pass</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mailbox.__init__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Mailbox.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;data</span><span class="se">\\</span><span class="s1">mailbox_log.txt&#39;</span></div>


<div class="viewcode-block" id="Mailbox.log_message">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Mailbox.log_message">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">formatted_datetime</span><span class="p">()</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">direction</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mailbox.send_message">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Mailbox.send_message">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot</span><span class="p">:</span> <span class="s1">&#39;Bot&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a message to the LLM service.</span>

<span class="sd">        Use to handle the specifics of communicating with a particular LLM API.</span>
<span class="sd">        Must handle message formatting, API calls, and initial response parsing.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            bot (Bot): Reference to the bot instance making the request.</span>
<span class="sd">                      Contains conversation history and configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Raw response from the LLM service</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: For API errors, rate limits, or other communication issues</span>

<span class="sd">        Note:</span>
<span class="sd">            - Should use bot.conversation for message history</span>
<span class="sd">            - May handle tool results depending on API requirements</span>
<span class="sd">            - Should respect bot.model_engine and other configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mailbox.process_response">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Mailbox.process_response">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">bot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Bot&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process the raw LLM response into a standardized format.</span>

<span class="sd">        Use to convert service-specific response formats into a consistent structure</span>
<span class="sd">        that can be used by the Bot class. Handles extraction of message content,</span>
<span class="sd">        role information, and any additional metadata.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            response (Dict[str, Any]): Raw response from the LLM service</span>
<span class="sd">            bot (Optional[Bot]): Reference to bot instance, required for services</span>
<span class="sd">                that need to send additional messages during processing (e.g.,</span>
<span class="sd">                OpenAI&#39;s tool handling)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, str, Dict[str, Any]]: Processed response containing:</span>
<span class="sd">                - response_text: The main message content</span>
<span class="sd">                - role: Message sender&#39;s role (e.g., &quot;assistant&quot;)</span>
<span class="sd">                - metadata: Additional information to be stored with the message</span>

<span class="sd">        Note:</span>
<span class="sd">            - If tool_handler is present, tool requests and results are already</span>
<span class="sd">              processed and available in tool_handler.requests/results</span>
<span class="sd">            - Metadata dict is passed directly to ConversationNode&#39;s kwargs</span>
<span class="sd">            - Each metadata item becomes an attribute of the ConversationNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;You must implement this method in a subclass&#39;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_log_outgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation</span><span class="p">:</span> <span class="n">ConversationNode</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Engines</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
        <span class="n">log_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">formatted_datetime</span><span class="p">(),</span> <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">conversation</span><span class="o">.</span><span class="n">_build_messages</span><span class="p">(),</span> <span class="s1">&#39;max_tokens&#39;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_message</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;OUTGOING&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_incoming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processed_response</span><span class="p">):</span>
        <span class="n">log_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">formatted_datetime</span><span class="p">(),</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">processed_response</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_message</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;INCOMING&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">formatted_datetime</span><span class="p">()</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">direction</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bot">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bot</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for LLM-powered conversational agents.</span>

<span class="sd">    The Bot class provides a unified interface for working with different LLM services,</span>
<span class="sd">    handling conversation management, tool usage, and state persistence. Key features:</span>

<span class="sd">    - Simple primary interface (respond(), chat())</span>
<span class="sd">    - Comprehensive tool support</span>
<span class="sd">    - Complete state preservation</span>
<span class="sd">    - Tree-based conversation management</span>
<span class="sd">    - Configurable parameters for each LLM</span>

<span class="sd">    The class is designed to make basic usage simple while allowing access to</span>
<span class="sd">    advanced features when needed.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        api_key (Optional[str]): API key for the LLM service</span>
<span class="sd">        name (str): Name identifier for the bot</span>
<span class="sd">        model_engine (Engines): The specific LLM model to use</span>
<span class="sd">        max_tokens (int): Maximum tokens in model responses</span>
<span class="sd">        temperature (float): Randomness in model responses (0.0-1.0)</span>
<span class="sd">        role (str): Bot&#39;s role identifier</span>
<span class="sd">        role_description (str): Detailed description of bot&#39;s role</span>
<span class="sd">        conversation (ConversationNode): Current conversation state</span>
<span class="sd">        system_message (str): System-level instructions for the bot</span>
<span class="sd">        tool_handler (Optional[ToolHandler]): Manager for bot&#39;s tools</span>
<span class="sd">        mailbox (Optional[Mailbox]): Handler for LLM communication</span>
<span class="sd">        autosave (bool): Whether to automatically save state</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyBot(Bot):</span>
<span class="sd">            def __init__(self, api_key: str):</span>
<span class="sd">                super().__init__(</span>
<span class="sd">                    api_key=api_key,</span>
<span class="sd">                    model_engine=Engines.GPT4,</span>
<span class="sd">                    name=&quot;MyBot&quot;,</span>
<span class="sd">                    role=&quot;assistant&quot;,</span>
<span class="sd">                    role_description=&quot;A helpful AI assistant&quot;</span>
<span class="sd">                )</span>

<span class="sd">        bot = MyBot(&quot;api_key&quot;)</span>
<span class="sd">        bot.add_tools(my_tools)</span>
<span class="sd">        response = bot.respond(&quot;Hello!&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Bot.__init__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">model_engine</span><span class="p">:</span> <span class="n">Engines</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                 <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">conversation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConversationNode</span><span class="p">]</span><span class="o">=</span><span class="n">ConversationNode</span><span class="o">.</span><span class="n">_create_empty</span><span class="p">(),</span> 
                 <span class="n">tool_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolHandler</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mailbox</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">autosave</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new Bot instance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            api_key (Optional[str]): API key for the LLM service</span>
<span class="sd">            model_engine (Engines): The specific LLM model to use</span>
<span class="sd">            max_tokens (int): Maximum tokens in model responses</span>
<span class="sd">            temperature (float): Randomness in model responses (0.0-1.0)</span>
<span class="sd">            name (str): Name identifier for the bot</span>
<span class="sd">            role (str): Bot&#39;s role identifier</span>
<span class="sd">            role_description (str): Detailed description of bot&#39;s role</span>
<span class="sd">            conversation (Optional[ConversationNode]): Initial conversation state</span>
<span class="sd">            tool_handler (Optional[ToolHandler]): Manager for bot&#39;s tools</span>
<span class="sd">            mailbox (Optional[Mailbox]): Handler for LLM communication</span>
<span class="sd">            autosave (bool): Whether to automatically save state after responses. Saves to cwd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span> <span class="o">=</span> <span class="n">model_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_description</span> <span class="o">=</span> <span class="n">role_description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">:</span> <span class="n">ConversationNode</span> <span class="o">=</span> <span class="n">conversation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span> <span class="o">=</span> <span class="n">tool_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailbox</span> <span class="o">=</span> <span class="n">mailbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span> <span class="o">=</span> <span class="n">autosave</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span> <span class="o">=</span> <span class="n">Engines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bot.respond">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.respond">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a prompt to the bot and get its response.</span>

<span class="sd">        This is the primary interface for interacting with the bot. The method:</span>
<span class="sd">        1. Adds the prompt to the conversation history</span>
<span class="sd">        2. Sends the conversation to the LLM</span>
<span class="sd">        3. Processes any tool usage requests</span>
<span class="sd">        4. Returns the final response</span>

<span class="sd">        Parameters:</span>
<span class="sd">            prompt (str): The message to send to the bot</span>
<span class="sd">            role (str): Role of the message sender (defaults to &#39;user&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The bot&#39;s response text</span>

<span class="sd">        Note:</span>
<span class="sd">            - Automatically saves state if autosave is enabled</span>
<span class="sd">            - Tool usage is handled automatically if tools are available</span>
<span class="sd">            - Full conversation context is maintained</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            bot.add_tools(file_tools)</span>
<span class="sd">            response = bot.respond(&quot;Please read config.json&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">_add_reply</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">reply</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cvsn_respond</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reply</span></div>


<div class="viewcode-block" id="Bot.add_tools">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.add_tools">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add Python functions as tools available to the bot.</span>

<span class="sd">        Use to provide the bot with capabilities by adding Python functions</span>
<span class="sd">        as tools. Functions&#39; docstrings are used to describe the tools to the LLM.</span>

<span class="sd">        The method is highly flexible in what it accepts:</span>
<span class="sd">        - Individual Python functions</span>
<span class="sd">        - Python files containing functions</span>
<span class="sd">        - Imported Python modules</span>
<span class="sd">        - Mixed combinations of the above</span>
<span class="sd">        - Lists/tuples of any supported type</span>

<span class="sd">        Parameters:</span>
<span class="sd">            *args: Variable arguments that can be:</span>
<span class="sd">                - str: Path to Python file with tools</span>
<span class="sd">                - ModuleType: Module containing tools</span>
<span class="sd">                - Callable: Single function to add</span>
<span class="sd">                - List/Tuple: Collection of any above types</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If an argument is not a supported type</span>
<span class="sd">            FileNotFoundError: If a specified file doesn&#39;t exist</span>
<span class="sd">            ModuleLoadError: If there&#39;s an error loading a module</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Single function</span>
<span class="sd">            bot.add_tools(calculate_area)</span>

<span class="sd">            # Multiple files and modules</span>
<span class="sd">            bot.add_tools(</span>
<span class="sd">                &quot;tools/file_ops.py&quot;,</span>
<span class="sd">                math_tools,</span>
<span class="sd">                &quot;tools/network.py&quot;,</span>
<span class="sd">                [process_data, custom_sort]</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Only adds top-level functions (not nested or class methods)</span>
<span class="sd">            - Preserves full module context for imported tools</span>
<span class="sd">            - Tools persist across save/load cycles</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">_add_tools_from_file</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">_add_tools_from_module</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">add_tool</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">process_item</span><span class="p">(</span><span class="n">subitem</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported type for tool addition: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">process_item</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bot._cvsn_respond">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot._cvsn_respond">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_cvsn_respond</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConversationNode</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a conversation turn with the LLM, including tool handling.</span>

<span class="sd">        Use when implementing core conversation flow. This method:</span>
<span class="sd">        1. Gets LLM response using current conversation context</span>
<span class="sd">        2. Handles any tool usage requests</span>
<span class="sd">        3. Updates conversation history</span>
<span class="sd">        4. Manages tool results and context</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, ConversationNode]:</span>
<span class="sd">                - response_text: The LLM&#39;s response text</span>
<span class="sd">                - node: The new conversation node created</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Any errors from LLM communication or tool execution</span>

<span class="sd">        Side Effects:</span>
<span class="sd">            - Updates conversation tree with new node</span>
<span class="sd">            - Processes tool requests if any</span>
<span class="sd">            - Updates tool results in conversation context</span>

<span class="sd">        Note:</span>
<span class="sd">            - Clears tool handler state before processing</span>
<span class="sd">            - Automatically handles tool request extraction</span>
<span class="sd">            - Maintains conversation tree structure</span>
<span class="sd">            - Preserves tool execution results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailbox</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">extract_requests</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">text</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailbox</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">_add_reply</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">_add_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">exec_requests</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">_add_tool_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="Bot.set_system_message">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.set_system_message">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_system_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the system-level instructions for the bot.</span>

<span class="sd">        Use to provide high-level guidance or constraints that should</span>
<span class="sd">        apply to all of the bot&#39;s responses.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            message (str): System instructions for the bot</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            bot.set_system_message(</span>
<span class="sd">                &quot;You are a code review expert. Focus on security and performance.&quot;</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_message</span> <span class="o">=</span> <span class="n">message</span></div>


<div class="viewcode-block" id="Bot.load">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Bot&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a saved bot from a file.</span>

<span class="sd">        Use to restore a previously saved bot with its complete state,</span>
<span class="sd">        including conversation history, tools, and configuration.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filepath (str): Path to the .bot file to load</span>
<span class="sd">            api_key (Optional[str]): New API key to use, if different from saved</span>

<span class="sd">        Returns:</span>
<span class="sd">            Bot: Reconstructed bot instance with restored state</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the specified file doesn&#39;t exist</span>
<span class="sd">            ValueError: If the file contains invalid bot data</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Save bot state</span>
<span class="sd">            bot.save(&quot;code_review_bot.bot&quot;)</span>

<span class="sd">            # Later, restore the bot</span>
<span class="sd">            bot = Bot.load(&quot;code_review_bot.bot&quot;, api_key=&quot;new_key&quot;)</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - API keys are not saved for security</span>
<span class="sd">            - Tool functions are fully restored with their context</span>
<span class="sd">            - Conversation history is preserved exactly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">bot_class</span> <span class="o">=</span> <span class="n">Engines</span><span class="o">.</span><span class="n">get_bot_class</span><span class="p">(</span><span class="n">Engines</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_engine&#39;</span><span class="p">]))</span>
        <span class="n">init_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">bot_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">constructor_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">init_params</span><span class="p">}</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">bot_class</span><span class="p">(</span><span class="o">**</span><span class="n">constructor_args</span><span class="p">)</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span> <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;tool_handler&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">tool_handler_class</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tool_handler&#39;</span><span class="p">][</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
            <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">tool_handler_class</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="n">actual_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">tool_handler</span> <span class="o">=</span> <span class="n">actual_class</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tool_handler&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_args</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;conversation&#39;</span><span class="p">,</span> <span class="s1">&#39;tool_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;conversation&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;conversation&#39;</span><span class="p">]:</span>
            <span class="n">node_class</span> <span class="o">=</span> <span class="n">Engines</span><span class="o">.</span><span class="n">get_conversation_node_class</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;conversation&#39;</span><span class="p">][</span><span class="s1">&#39;node_class&#39;</span><span class="p">])</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="n">node_class</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;conversation&#39;</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">bot</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                <span class="n">bot</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">replies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bot</span></div>


<div class="viewcode-block" id="Bot.save">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the bot&#39;s complete state to a file.</span>

<span class="sd">        Use to preserve the bot&#39;s entire state including:</span>
<span class="sd">        - Configuration and parameters</span>
<span class="sd">        - Conversation history</span>
<span class="sd">        - Tool definitions and context</span>
<span class="sd">        - System messages and role information</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filename (Optional[str]): Name for the save file</span>
<span class="sd">                If None, generates name using bot name and timestamp</span>
<span class="sd">                Adds .bot extension if not present</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the saved file</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Save with generated name</span>
<span class="sd">            path = bot.save()  # e.g., &quot;MyBot@2024-01-20_15-30-45.bot&quot;</span>

<span class="sd">            # Save with specific name</span>
<span class="sd">            path = bot.save(&quot;code_review_bot&quot;)  # saves as &quot;code_review_bot.bot&quot;</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - API keys are not saved for security</span>
<span class="sd">            - Creates directories in path if they don&#39;t exist</span>
<span class="sd">            - Maintains complete tool context for restoration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">formatted_datetime</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s1">.bot&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bot&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.bot&#39;</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)}</span>
        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mailbox&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bot_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;model_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span><span class="o">.</span><span class="n">value</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;conversation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">_root_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tool_handler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="Bot.chat">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.chat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start an interactive chat session with the bot.</span>

<span class="sd">        Use when you want to have a continuous conversation with the bot</span>
<span class="sd">        in the terminal. The session continues until &#39;/exit&#39; is entered.</span>

<span class="sd">        Features:</span>
<span class="sd">        - Simple text-based interface</span>
<span class="sd">        - Shows tool usage information</span>
<span class="sd">        - Maintains conversation context</span>
<span class="sd">        - Visual separators between messages</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            bot.add_tools(my_tools)</span>
<span class="sd">            bot.chat()</span>
<span class="sd">            # You: Please analyze the code in main.py</span>
<span class="sd">            # Bot: I&#39;ll take a look...</span>
<span class="sd">            # Used Tool: view_file</span>
<span class="sd">            # ...</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Enter &#39;/exit&#39; to end the session</span>
<span class="sd">            - Tool usage is displayed if tools are available</span>
<span class="sd">            - State is saved according to autosave setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;System: Chat started. Type &quot;/exit&quot; to exit.&#39;</span><span class="p">)</span>
        <span class="n">uinput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">uinput</span> <span class="o">!=</span> <span class="s1">&#39;/exit&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
            <span class="n">uinput</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;You: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uinput</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">uinput</span> <span class="o">==</span> <span class="s1">&#39;/exit&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="n">uinput</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">get_requests</span><span class="p">():</span>
                    <span class="n">tool_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">tool_name_and_input</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Used Tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bot.__mul__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.__mul__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;Bot&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create multiple copies of this bot.</span>

<span class="sd">        Use when you need multiple instances of the same bot configuration,</span>
<span class="sd">        for example when running parallel operations.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            other (int): Number of copies to create</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Bot]: List of independent bot copies</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            # Create 3 identical bots</span>
<span class="sd">            bots = base_bot * 3</span>
<span class="sd">            </span>
<span class="sd">            # Use in parallel operations</span>
<span class="sd">            results = [bot.respond(&quot;Hello&quot;) for bot in bots]</span>
<span class="sd">            ```</span>

<span class="sd">        Note:</span>
<span class="sd">            - Each copy is completely independent</span>
<span class="sd">            - Copies include all configuration and tools</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">other</span><span class="p">)]</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Bot multiplcation not defined for non-integer values&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Bot.__str__">
<a class="viewcode-back" href="../../../source/bots.foundation.html#bots.Bot.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a human-readable string representation of the bot.</span>

<span class="sd">        Use when you need a detailed, formatted view of the bot&#39;s state,</span>
<span class="sd">        including conversation history and tool usage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted string containing:</span>
<span class="sd">                - Bot metadata (name, role, model)</span>
<span class="sd">                - Complete conversation history with indentation</span>
<span class="sd">                - Tool calls and results</span>
<span class="sd">                - Available tool count</span>

<span class="sd">        Note:</span>
<span class="sd">            - Conversation is shown as a tree structure</span>
<span class="sd">            - Tool results are included with each message</span>
<span class="sd">            - Handles deep conversation trees with level indicators</span>
<span class="sd">            - Formats content for readable terminal output</span>

<span class="sd">        Example:</span>
<span class="sd">            ```python</span>
<span class="sd">            bot = MyBot(&quot;api_key&quot;)</span>
<span class="sd">            print(bot)  # Shows complete bot state</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">format_conversation</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">display_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">indent_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">marker_size</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent_size</span> <span class="o">*</span> <span class="n">display_level</span>
            <span class="n">available_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">80</span> <span class="o">-</span> <span class="n">display_level</span> <span class="o">*</span> <span class="n">indent_size</span> <span class="o">-</span> <span class="n">marker_size</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;You&#39;</span>
                <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;assistant&#39;</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;System&#39;</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">display_level</span><span class="p">:</span>
                <span class="n">hidden_levels</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="n">display_level</span>
                <span class="k">if</span> <span class="n">hidden_levels</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">depth_indicator</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">*</span> <span class="n">hidden_levels</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">depth_indicator</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&gt;&gt;&gt;(</span><span class="si">{</span><span class="n">hidden_levels</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="n">name_display</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">depth_indicator</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_display</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">wrapped_content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">available_width</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;│ &#39;</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;│ &#39;</span><span class="p">))</span>
            <span class="n">tool_info</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;tool_calls&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Tool Calls:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;tool_results&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span><span class="p">:</span>
                <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Tool Results:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))[:</span><span class="n">available_width</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;pending_results&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">pending_results</span><span class="p">:</span>
                <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Pending Results:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">pending_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">tool_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))[:</span><span class="n">available_width</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="n">tool_info_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_info</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_info</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">┌─ </span><span class="si">{</span><span class="n">name_display</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped_content</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;tool_calls&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Tool Calls:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;tool_results&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Tool Results:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tool_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))[:</span><span class="n">available_width</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;pending_results&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">pending_results</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">│ Pending Results:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">pending_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">│   - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))[:</span><span class="n">available_width</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">└&#39;</span> <span class="o">+</span> <span class="s1">&#39;─&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;replies&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">reply</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">replies</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">format_conversation</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">messages</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;╔&#39;</span> <span class="o">+</span> <span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;║ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;║ Role: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;║ Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_engine</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="p">:</span>
            <span class="n">tool_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_handler</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;║ Tools Available: </span><span class="si">{</span><span class="n">tool_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;╚&#39;</span> <span class="o">+</span> <span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="mi">78</span> <span class="o">+</span> <span class="s1">&#39;╝</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span>
            <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">format_conversation</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, benbuzz790.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>